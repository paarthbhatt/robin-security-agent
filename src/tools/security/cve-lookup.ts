import { DynamicStructuredTool } from '@langchain/core/tools';
import { z } from 'zod';

export const cveLookup = new DynamicStructuredTool({
  name: 'cve_lookup',
  description: 'Lookup vulnerability details using a CVE ID. Returns descriptions, severity, and potential mitigations.',
  schema: z.object({
    cveId: z.string().describe('The CVE ID to look up (e.g., CVE-2024-12345)'),
  }),
  func: async ({ cveId }) => {
    try {
      // Using the NVD API (National Vulnerability Database)
      const response = await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${cveId}`);
      if (!response.ok) return `Error: Unable to reach NVD API (Status ${response.status})`;
      
      const data = await response.json();
      if (!data.vulnerabilities || data.vulnerabilities.length === 0) {
        return `No data found for ${cveId}. It might be reserved or not yet published.`;
      }

      const vuln = data.vulnerabilities[0].cve;
      const description = vuln.descriptions.find((d: any) => d.lang === 'en')?.value || 'No description available.';
      const metrics = vuln.metrics?.cvssMetricV31?.[0]?.cvssData || vuln.metrics?.cvssMetricV30?.[0]?.cvssData;
      
      let result = `### ${cveId}\n\n**Description:** ${description}\n\n`;
      if (metrics) {
        result += `**Severity:** ${metrics.baseSeverity} (${metrics.baseScore})\n`;
        result += `**Vector:** ${metrics.vectorString}\n`;
      }

      return result;
    } catch (error: any) {
      return `Error looking up CVE: ${error.message}`;
    }
  },
});
